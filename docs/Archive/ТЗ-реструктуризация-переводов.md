# Техническое задание: реструктуризация хранения переведённых языковых данных

**Версия:** 1.0  
**Дата:** 2025-02-22  
**Цель:** Переход от одного файла перевода на язык к иерархической структуре папок по языкам и отдельных файлов по группам, соответствующим оригинальным данным.

---

## 1. Текущее состояние

### 1.1 Структура данных

- **Оригинальные данные:** папка `data/` (кроме `data/lang/`)
  - Подпапки: `_ui/`, `human/`, `hai/`, `remnant/`, `wanderer/`, `successors/`, `korath/`, `incipias/`, `gegno/`, `kahet/`, `pug/`, `vyrmeid/`, `sheragi/`, `rulei/`, `quarg/`, и др.
  - Файлы верхнего уровня: `gamerules.txt`, `commodities.txt`, `formations.txt`, `governments.txt`, `harvesting.txt`, `starts.txt`, `series.txt`, `substitutions.txt`, `dialog phrases.txt`, `persons.txt`, `categories.txt`, `map planets.txt`, `map beyond patir.txt`, `map systems.txt`, `stars.txt`, и др.
  - Каждая папка содержит свои `.txt` (ships.txt, outfits.txt, missions.txt, news.txt, jobs.txt и т.д.)

- **Переводы:** `data/lang/`
  - `ru.json`, `en.json` — по одному плоскому JSON-файлу на язык
  - Все ключи в одном файле (порядка 1300+ строк)
  - Формат: `"ключ": "перевод"`, например `"prefs.expend_ammo": "Эскорт тратит боеприпасы"`

### 1.2 Загрузка в коде

- **Файлы:** `source/text/Translation.cpp`, `source/text/Translation.h`
- **Функции:**
  - `Load(const string &languageCode)` — загружает `data/lang/<код>.json`
  - `LoadInto(languageCode, target)` — читает один JSON-файл
  - `AvailableLanguageCodes()` — ищет `.json` в `data/lang/`
- **Парсинг:** `ParseFlatJson()` — разбирает плоский JSON в `map<string, string>`

### 1.3 Префиксы ключей и источники

| Префикс | Источник | Пример ключа |
|---------|----------|--------------|
| `language.` | метаданные языков | `language.name_ru` |
| `prefs.` | PreferencesPanel, код | `prefs.expend_ammo` |
| `bank.` | банк | `bank.heading_type` |
| `gamerules.` | gamerules.txt | `gamerules.depreciation_min` |
| `message.` | _ui/messages.txt | `message.no_formations` |
| `date.` | форматирование дат | `date.weekday_sat` |
| `dialog.` | диалоги | `dialog.done` |
| `hail.` | hail-сообщения | `hail.no_response` |
| `mission.` | миссии UI | `mission.available_here` |
| `ui.` | интерфейс | `ui.outfit` |
| `category.` | categories.txt | `category.Guns` |
| `formation.` | formations.txt | `formation.Atomic` |
| `government.` | governments.txt | `government.Republic` |
| `start.` | starts.txt | `start.name.default` |
| `commodity.` | commodities.txt | `commodity.Food` |
| `outfit.` | harvesting.txt, */*outfits*.txt | `outfit.name.Beam Laser` |
| `ship.` | */*ships*.txt | `ship.name.Sparrow` |
| `planet.desc.`, `planet.spaceport.`, `planet.name.` | map planets.txt, map beyond patir.txt | `planet.desc.New Boston` |
| `system.name.` | map systems, substitutions | `system.name.Sol` |
| `series.` | series.txt | `series.Guns` |
| `phrase.` | dialog phrases.txt | `phrase.<id>` |
| `help.` | _ui/help.txt | `help.title.jobs` |
| `job.` | jobs | `job.Bulk delivery to` |
| `trade.` | торговля | `trade.free` |
| `shop.`, `btn.`, `ship_info.` | UI | `shop.your_ships` |
| Литералы без префикса | _ui/interfaces.txt | `"Ship Info": "Информация о корабле"` |

---

## 2. Целевая структура

### 2.1 Общая схема

```
data/lang/
├── ru/
│   ├── _meta.json         # language.name_ru, language.name_en
│   ├── prefs.json
│   ├── bank.json
│   ├── gamerules.json
│   ├── messages.json      # message.*
│   ├── date.json
│   ├── dialog.json        # dialog.*
│   ├── hail.json
│   ├── mission.json
│   ├── ui.json            # ui.*, shop.*, btn.*, ship_info.*, литералы из interfaces
│   ├── help.json
│   ├── categories.json
│   ├── formations.json
│   ├── governments.json
│   ├── commodities.json
│   ├── series.json
│   ├── starts.json
│   ├── phrases.json       # phrase.*
│   ├── jobs.json          # job.*
│   ├── trade.json
│   ├── outfits.json       # outfit.name.*, outfit.desc.*, outfit.plural.*
│   ├── ships.json         # ship.name.*, ship.plural.*
│   ├── planets.json       # planet.desc.*, planet.spaceport.*, planet.name.*
│   └── systems.json       # system.name.*
├── en/
│   └── (аналогично ru/)
└── (для обратной совместимости: можно оставить ru.json как fallback при миграции)
```

### 2.2 Соответствие групп и оригинальных данных

| Файл перевода | Оригинальный источник |
|---------------|------------------------|
| `_meta.json` | — (метаданные языков) |
| `prefs.json` | PreferencesPanel, хардкод в коде |
| `bank.json` | Bank panel |
| `gamerules.json` | `data/gamerules.txt` |
| `messages.json` | `data/_ui/messages.txt` |
| `date.json` | форматирование дат в коде |
| `dialog.json` | диалоговые окна в коде |
| `hail.json` | hail-сообщения (частично governments, код) |
| `mission.json` | UI миссий |
| `ui.json` | `data/_ui/interfaces.txt`, `_ui/tooltips.txt`, и др. |
| `help.json` | `data/_ui/help.txt` |
| `categories.json` | `data/categories.txt` |
| `formations.json` | `data/formations.txt` |
| `governments.json` | `data/governments.txt` |
| `commodities.json` | `data/commodities.txt` |
| `series.json` | `data/series.txt` |
| `starts.json` | `data/starts.txt` |
| `phrases.json` | `data/dialog phrases.txt` |
| `jobs.json` | jobs из data/*/jobs.txt и др. |
| `trade.json` | торговый UI |
| `outfits.json` | `data/harvesting.txt`, `data/human/*outfits*.txt`, `data/*/outfits.txt` |
| `ships.json` | `data/*/ships.txt` |
| `planets.json` | `data/map planets.txt`, `data/map beyond patir.txt` |
| `systems.json` | `data/map systems.txt`, `data/substitutions.txt` (system.name) |

### 2.3 Вариант разбиения по папкам оригинала

Для outfit/ship/planet можно вместо одного файла использовать разбиение по папкам оригинала:

```
data/lang/ru/
├── human/
│   ├── outfits.json
│   └── ships.json
├── hai/
│   ├── outfits.json
│   └── ships.json
├── harvesting.json
└── ...
```

**Рекомендация:** начать с плоского варианта (outfits.json, ships.json, planets.json) — проще миграция и поддержка. Разбиение по папкам рассмотреть при большом объёме переводов.

---

## 3. Изменения в коде

### 3.1 Обнаружение языков

**Было:** `AvailableLanguageCodes()` — ищет `*.json` в `data/lang/`.

**Станет:** искать подпапки в `data/lang/`, каждая подпапка = язык (если содержит хотя бы один `.json`).

```cpp
// Псевдокод
vector<string> AvailableLanguageCodes()
{
    path langDir = Files::Data() / "lang";
    vector<string> codes;
    for (entry : Files::List(langDir))
    {
        if (entry.is_directory())
            codes.push_back(entry.name());
        else if (entry.extension() == ".json")  // обратная совместимость: ru.json
            codes.push_back(entry.stem());
    }
    return codes;
}
```

### 3.2 Загрузка переводов

**Было:** один вызов `LoadInto(languageCode, target)` → читает `lang/<code>.json`.

**Станет:** для выбранного языка загружать все JSON-файлы из `lang/<code>/` и сливать в единый `map<string, string>`.

**Список файлов для загрузки (порядок важен при конфликтах ключей):**

1. `_meta.json`
2. `prefs.json`, `bank.json`, `gamerules.json`, `messages.json`, `date.json`
3. `dialog.json`, `hail.json`, `mission.json`, `ui.json`, `help.json`
4. `categories.json`, `formations.json`, `governments.json`, `commodities.json`
5. `series.json`, `starts.json`, `phrases.json`, `jobs.json`, `trade.json`
6. `outfits.json`, `ships.json`, `planets.json`, `systems.json`

Или: загружать все `.json` в папке в алфавитном порядке.

```cpp
// Псевдокод LoadInto
void LoadInto(const string &languageCode, map<string, string> &target)
{
    target.clear();
    path langPath = Files::Data() / "lang" / languageCode;

    if (filesystem::is_directory(langPath))
    {
        for (entry : Files::List(langPath))
        {
            if (entry.extension() == ".json")
            {
                string data = Files::Read(entry.path());
                map<string, string> partial;
                ParseFlatJson(data, partial);
                for (auto &p : partial)
                    target[p.first] = p.second;
            }
        }
    }
    else
    {
        path singleFile = Files::Data() / "lang" / (languageCode + ".json");
        if (Files::Exists(singleFile))
        {
            string data = Files::Read(singleFile);
            ParseFlatJson(data, target);
        }
    }
}
```

### 3.3 Обратная совместимость

- Если в `data/lang/` лежит `ru.json`, а папки `ru/` нет — использовать файл `ru.json` (как сейчас).
- Если есть папка `ru/` — загружать из неё.
- Приоритет: папка над файлом (сначала проверять `lang/ru/`, потом `lang/ru.json`).

### 3.4 Затрагиваемые файлы

| Файл | Изменения |
|------|-----------|
| `source/text/Translation.cpp` | `LoadInto()`, `AvailableLanguageCodes()` |
| `source/text/Translation.h` | Без изменений сигнатур |
| Остальной код | Без изменений (API Tr/TrCategory/... не меняется) |

---

## 4. Миграция данных

### 4.1 Скрипт разбиения ru.json → ru/

Требуется скрипт (Python/Node/ручной), который:

1. Читает `data/lang/ru.json`
2. Разбивает ключи по группам (префиксы + литералы)
3. Создаёт `data/lang/ru/` и сохраняет в неё отдельные JSON-файлы

Правила разнесения ключей:

- `language.*` → `_meta.json`
- `prefs.*` → `prefs.json`
- `bank.*` → `bank.json`
- и т.д. по таблице из п. 2.2
- Ключи без точки (литералы, например `"Ship Info"`) → `ui.json`

### 4.2 Порядок миграции

1. Реализовать скрипт разбиения и получить структуру `lang/ru/`, `lang/en/`
2. Внести изменения в `Translation.cpp`
3. Убедиться, что игра загружает переводы из новой структуры
4. Удалить старые `ru.json`, `en.json` (или оставить как бэкап)

---

## 5. Преимущества новой структуры

- Переводы сгруппированы по смыслу и источнику данных
- Удобнее добавлять новые переводы в нужный файл
- Можно включать/выключать переводы по группам (для отладки или плагинов)
- Лучше работа с Git (меньше конфликтов при изменении разных групп)
- Соответствие структуре оригинальных данных упрощает сопровождение

---

## 6. Риски и ограничения

- При дублировании ключа в разных файлах побеждает последний загруженный (зависит от порядка обхода)
- Нужно обеспечить порядок загрузки или явный список файлов
- Плагины, добавляющие свои переводы, должны следовать новой структуре или поддерживать fallback на старый формат

---

## 7. Критерии приёмки

1. `data/lang/ru/` и `data/lang/en/` содержат разбитые JSON-файлы
2. `Translation::Load("ru")` загружает все переводы из `lang/ru/`
3. `Translation::AvailableLanguageCodes()` возвращает коды языков (в т.ч. из подпапок)
4. Игра отображает переводы корректно при выборе ru/en
5. Сохранена обратная совместимость со старым форматом `lang/<code>.json` (опционально)
