# Техническое задание: доперевод текстов Endless Sky

**Версия:** 1.0  
**Дата:** 2025-02-22  
**Цель:** Дополнить перевод на русский язык — перевести то, что ещё не переведено в `data/lang/ru.json`, и при необходимости внести правки в код для отображения переведённых текстов.

---

## 1. Обзор

### 1.1 Текущее состояние

- Модуль локализации реализован: `source/text/Translation.cpp`, `Translation.h`
- Переводы хранятся в `data/lang/ru.json` в формате `"ключ": "строка"`
- API: `Tr(key)`, `TrCategory()`, `TrOutfitName()`, `TrOutfitDescription()`, `TrOutfitPluralName()`, `TrShipName()`, `TrShipPluralName()`, `TrPlanetDescription()`, `TrSpaceportDescription()`
- В `ru.json` уже переведено ~1320 строк: UI, банк, настройки, gamerules, даты, сообщения, hail, категории, commodity, outfit, ship, planet.desc, planet.spaceport

### 1.2 Область доперевода

1. **Тексты из data-файлов**, для которых API уже есть, но переводы отсутствуют или неполные:
   - outfit (name, desc, plural) — из harvesting.txt, outfits в human/, coalition/, и т.д.
   - ship (name, plural) — из ships
   - planet.desc, planet.spaceport — из data/map planets.txt, data/map beyond patir.txt
   - commodity — основные товары уже есть; отдельные названия в commodities.txt (например, "acorns", "alfalfa") — используются в подстановках, нужна проверка, требуют ли они перевода
   - category — частично есть
   - formation — названия формаций (Atomic, Circle, и т.д.) — **проверить, используется ли Tr() для них**
   - government display name — **проверить, используется ли Tr()**
   - hazard names — **проверить, отображаются ли игроку**

2. **Тексты из data-файлов**, для которых API пока **нет** — потребуются правки в коде:
   - **phrases** (`data/dialog phrases.txt`) — диалоговые фразы, используются через `Phrase::Get()` без Tr(); нужен `TrPhrase(phraseName)` или обёртка
   - **starts** — имена и описания стартов (`data/starts.txt`)
   - **series** — названия серий outfit (`data/series.txt`) — категории в outfit
   - **substitutions** — значения подстановок (`data/substitutions.txt`)
   - **globals** — mission display names, conversation text
   - **effects** — имена эффектов (если отображаются)
   - **persons** — имена и hail-фразы (через Phrase)

3. **Тексты в коде** — возможно, остались литералы без Tr()

---

## 2. Источники данных и ключи

| Файл / источник | Ключ в ru.json | API / использование | Статус |
|-----------------|----------------|---------------------|--------|
| categories.txt | `category.<name>` | TrCategory() | Частично переведено |
| commodities.txt | `commodity.<name>` | Tr("commodity."+name) | 19 товаров переведено; проверить полный список |
| harvesting.txt | outfit.name/desc/plural | TrOutfitName/Desc/Plural | Частично (Aluminum, Copper и др. — нужен полный список) |
| human/outfits, */*.txt | outfit.* | TrOutfitName/Desc/Plural | Частично |
| human/ships, */*.txt | ship.name, ship.plural | TrShipName, TrShipPluralName | Частично |
| map planets.txt, map beyond patir.txt | planet.desc, planet.spaceport | TrPlanetDescription, TrSpaceportDescription | Большинство planet.desc переведено |
| formations.txt | formation.<name> | TrFormation() | *выполнено* |
| governments.txt | government.<name> | TrGovernment() | *выполнено* |
| hazards.txt | hazard.<name> | — | Проверить отображение |
| effects.txt | effect.<name> | — | Обычно технические, не показываются |
| dialog phrases.txt | phrase.<id> | TrPhrase() в Phrase::Get() | *выполнено* |
| starts.txt | start.name.<id>, start.desc.<id> | TrStartName, TrStartDescription | *выполнено* |
| series.txt | series.<name> | TrSeries(), TranslatedSeries() | *выполнено* |
| substitutions.txt | planet.name.*, system.name.*, commodity.*, government.* | TrSubstitutionValue, Format::ReplaceTranslated | *выполнено* |
| _ui/messages.txt | message.* | Уже в коде | Частично |
| _ui/tooltips.txt | tooltip.* | — | Проверить |
| _ui/help.txt | help.* | Частично в ru.json | Частично |
| _ui/interfaces.txt | — | label, string, button | Проверить |

---

## 3. Правки в коде (при необходимости)

### 3.1 Формации (formations) *выполнено*

- **Проверить:** где отображаются названия формаций (Atomic, Circle, Line, …)
- **Файлы:** AI.cpp, FormationPanel (если есть), выбор формации в UI
- **Действие:** при отображении использовать `Tr("formation." + formationName)`; добавить `TrFormation()` в Translation.h/cpp по аналогии с TrCategory

### 3.2 Правительства (governments) *выполнено*

- **Проверить:** Government::DisplayName() — откуда берётся и выводится ли игроку
- **Действие:** при выводе использовать `Tr("government." + displayName)` или `TrGovernment(displayName)`

### 3.3 Фразы (phrases) *выполнено*

- **Проблема:** `Phrase::Get()` возвращает строку из data; при смене языка фразы остаются на английском
- **Варианты:**
  - **A:** В `Phrase::Get()` или в точке вывода проверять текущий язык и подставлять `Tr("phrase." + phraseName)` вместо raw-строки
  - **B:** Добавить `TrPhrase(phraseName, fallback)` и вызывать его везде, где показывается результат phrase (DialogSettings, Government::GetHail(), Message::GetMessage(), и т.д.)
- **Сложность:** фразы содержат вложенные `${phrase name}` и подстановки `<planet>`, `<npc>` — перевод должен сохранять плейсхолдеры
- **Рекомендация:** Вариант B — обёртка `TrPhrase()`; ключи `phrase.<phrase-id>`, где phrase-id — идентификатор из `phrase "id"` в data

### 3.4 Старты (starts) *выполнено*

- **Проверить:** LoadPanel, выбор старта — откуда берутся name и description
- **Действие:** использовать `Tr("start.name.<id>")`, `Tr("start.desc.<id>")` при отображении

### 3.5 Substitutions *выполнено*

- **Проблема:** подстановки вида `<home planet>` → "New Boston" хранятся в substitutions.txt
- **Действие:** использовать уже переведённые значения: TrSubstitutionValue(key, value) для commodity, government, planet.name, system.name; Format::ReplaceTranslated; TranslateSubstitutionValues в GetSubstitutions

### 3.6 Commodity в MapDetailPanel *выполнено*

- **Проблема:** `MapDetailPanel.cpp:887` рисует `commodity.name` напрямую, без Tr()
- **Действие:** заменить на `Translation::Tr("commodity." + commodity.name)` с fallback на `commodity.name`

### 3.7 Серии (series) *выполнено*

- **Проверить:** используются ли названия серий (Guns, Turrets, Drives, …) в UI
- **Действие:** TrSeries(), Outfit::TranslatedSeries(); ключи series.* в ru.json

---

## 4. План работ по этапам

### Этап 1: Анализ и извлечение непереведённых ключей (1 субагент)

- Скрипт или ручная выгрузка всех ключей из en.json (если есть) или из кода/data
- Сравнение с ru.json — список ключей, отсутствующих в ru.json
- Результат: `docs/translation-gaps.json` или markdown-таблица

### Этап 2: Правки в коде (2–3 субагента, можно распараллелить)

- **Субагент 2.1:** formation, government — добавить TrFormation, TrGovernment, вставить вызовы
- **Субагент 2.2:** phrase — добавить TrPhrase, вставить вызовы в DialogSettings, Government, Message, Phrase::Get (осторожно с рекурсией)
- **Субагент 2.3:** MapDetailPanel commodity, starts, substitutions — точечные правки

### Этап 3: Доперевод по группам (параллельно по 10 субагентов)

Ниже — **10 групп**, каждую может выполнять отдельный субагент. Каждая группа независима и может идти параллельно.

| № | Группа | Источник | Ключи | Примерный объём |
|---|--------|----------|-------|-----------------|
| 1 | outfit.name | harvesting, human/outfits, coalition/… | outfit.name.* | ~200–400 |
| 2 | outfit.desc | то же | outfit.desc.* | ~200–400 |
| 3 | outfit.plural | то же | outfit.plural.* | ~200–400 |
| 4 | ship.name | human/ships, coalition/ships, … | ship.name.* | ~100–200 |
| 5 | ship.plural | то же | ship.plural.* | ~100–200 |
| 6 | planet.desc | map planets.txt, map beyond patir.txt | planet.desc.* | Довольно много уже переведено; оставшиеся |
| 7 | planet.spaceport | то же | planet.spaceport.* | Оставшиеся |
| 8 | category, commodity, formation, government | categories, commodities, formations, governments | category.*, commodity.*, formation.*, government.* | ~50–100 |
| 9 | phrase | dialog phrases.txt | phrase.* | ~30–50 фраз |
| 10 | start, help, job, tooltip, прочее UI | starts.txt, _ui/help.txt, job keys, tooltips | start.name.*, start.desc.*, help.*, job.*, tooltip.* | ~50–150 |

### Этап 4: Валидация

- Проверка JSON на корректность
- Запуск игры, проверка отображения
- Проверка отсутствия «кракозябр» (UTF-8, кириллица)

---

## 5. Параллельный запуск субагентов

Для ускорения и экономии токенов:

- **Этап 2:** до 3 субагентов параллельно (2.1, 2.2, 2.3)
- **Этап 3:** до **10 субагентов** параллельно (группы 1–10)

Итого: до 10 субагентов одновременно на этапе перевода.

---

## 6. Формат ru.json и соглашения

- Кодировка: UTF-8 без BOM
- Ключи: латиница, lowercase, разделитель `.`
- Плейсхолдеры: `{{name}}`, `{{value}}`, `{{count}}` — не переводить, сохранять в переводе
- В описаниях outfit/ship: символ `\n` — перенос строки, `\t` — табуляция
- Ссылки на примеры уже переведённого: строки 4–350, 655–760 в ru.json

---

## 7. Ссылки на код

| Компонент | Файл | Строки/функции |
|-----------|------|----------------|
| Translation API | source/text/Translation.cpp | Tr, TrCategory, TrOutfit*, TrShip*, TrPlanet*, TrSpaceport* |
| Commodity display | source/TradingPanel.cpp | 171: Tr("commodity." + commodity.name) |
| Commodity в карте | source/MapDetailPanel.cpp | Tr("commodity."+name) с fallback | *выполнено* |
| Planet description | source/PlanetPanel.cpp | 73, 241: TrPlanetDescription |
| Spaceport | source/SpaceportPanel.cpp | 108: TrSpaceportDescription |
| Phrase | source/Phrase.cpp | Get(), ExpandPhrases() |
| Government hail | source/Government.cpp | GetHail(), friendlyHail, hostileHail |
| Dialog | source/DialogSettings.cpp | phrase, to display |
| Formation | source/AI.cpp | TrFormation() в message.ships_will_assume_formation | *выполнено* |

---

## 8. Риски и ограничения

- **Phrases:** вложенные фразы и подстановки усложняют механизм TrPhrase; возможен вариант «переводить только верхний уровень»
- **Контент missions/conversations:** текст внутри миссий и диалогов задаётся в data-файлах (human/free worlds, coalition/…); вынос в ru.json — отдельный большой объём; в данном ТЗ — фокус на phrases, UI, outfit/ship/planet
- **Регрессии:** любая правка в коде — риск; тестировать после каждой группы изменений

---

## 9. Результат

- `data/lang/ru.json` — дополнен переводами для всех ключей из этапа 3
- Код — точечные правки для formation, government, phrase, commodity в карте, starts, substitutions (если применимо)
- Документ `docs/translation-gaps.md` (или аналог) — список закрытых пропусков
- Игра на русском языке отображает переведённые тексты в UI, на карте, в описаниях outfit/ship/planet, в фразах (после внедрения TrPhrase)
